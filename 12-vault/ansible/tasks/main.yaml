- name: Set-prompt
  ansible.builtin.shell: sudo set-prompt {{tool_name}}

- name: Import HashiCorp GPG key
  ansible.builtin.rpm_key:
    state: present
    key: https://rpm.releases.hashicorp.com/gpg
  become: true

# Pin to RHEL 9 (not $releasever) to avoid 404 on RHUI
- name: Add HashiCorp repo for RHEL 9
  ansible.builtin.copy:
    dest: /etc/yum.repos.d/hashicorp.repo
    mode: "0644"
    content: |
      [hashicorp]
      name=HashiCorp Stable - $basearch
      baseurl=https://rpm.releases.hashicorp.com/RHEL/9/$basearch/stable
      enabled=1
      gpgcheck=1
      gpgkey=https://rpm.releases.hashicorp.com/gpg
  become: true

- name: Rebuild metadata cache
  ansible.builtin.command: dnf -y makecache
  changed_when: true
  become: true

- name: Install Vault
  ansible.builtin.dnf:
    name: vault
    state: present
    update_cache: true
  become: true

- name: Updating vault repo file
  ansible.builtin.template:
    src: vault.hcl.j2
    dest: /etc/vault.d/vault.hcl

- name: start vault
  ansible.builtin.systemd_service:
    name: vault
    state: started
    enabled: yes
